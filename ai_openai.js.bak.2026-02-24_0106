const OpenAI = require("openai");

function extractOutputText(resp) {
  const out = [];
  if (!resp || !Array.isArray(resp.output)) return "";
  for (const item of resp.output) {
    if (item && item.type === "message" && Array.isArray(item.content)) {
      for (const c of item.content) {
        if (c && c.type === "output_text" && typeof c.text === "string") {
          out.push(c.text);
        }
      }
    }
  }
  return out.join("\n").trim();
}

async function aiOrchestrate({ text, logger }) {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) throw new Error("OPENAI_API_KEY missing");

  const model = process.env.OPENAI_MODEL || "gpt-4o-2024-08-06";
  const client = new OpenAI({ apiKey });

  const system = `
Tu es le conseiller exécutif stratégique 10X d’Olivier Allaire.

Tu es brutalement lucide.
Tu ne rassures pas.
Tu ne motives pas.
Tu structures.

Tu analyses toujours :
Argent. Temps. Énergie. Structure. Dépendance à Olivier. Effet levier.

Tu détectes :
- Ego
- Peur
- Sauveur
- Contrôle inutile
- Fatigue décisionnelle

Tu refuses :
- Les réponses molles
- Les généralisations
- Les conseils vagues

Tu retournes UNIQUEMENT un JSON valide :

{
  "intent": "infra|construction|finance|legal|general",
  "summary": "vérité brute en 1-2 phrases",
  "actions": ["étapes stratégiques claires et concrètes"],
  "next_step": "1 action impérative immédiate"
}

Aucun texte hors JSON.
`;

  const user = `Message:\n${text}`;

  try {
    const resp = await client.responses.create({
      model,
      input: [
        { role: "system", content: [{ type: "input_text", text: system }] },
        { role: "user", content: [{ type: "input_text", text: user }] }
      ],
      text: { format: { type: "text" } }
    });

    const raw = extractOutputText(resp);
    if (!raw) throw new Error("Empty model output");

    let obj = JSON.parse(raw);

    if (!obj.intent) obj.intent = "general";
    if (!obj.summary) obj.summary = "Analyse incomplète.";
    if (!Array.isArray(obj.actions)) obj.actions = [];
    if (!obj.next_step) obj.next_step = "Clarifie ton objectif stratégique.";

    return obj;

  } catch (err) {
    if (logger) logger.error({ err: err.message }, "ai_error");
    throw err;
  }
}

module.exports = { aiOrchestrate };
